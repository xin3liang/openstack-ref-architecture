# Gather facts from all nodes
#
- hosts: all
  tasks:
    - name: setup
      setup:

# Make sure monitoring agent and time agent are in all servers
#
- name: Configure ntp and zabbix_agents
  hosts: all
  become: yes
  vars_files:
    - ["secrets/deployment-vars", "deployment-vars.example"]
    - ["secrets/host_vars/{{inventory_hostname}}", "vars/empty"]
  roles:
    - {role: ntp, tags: [ntp]}
    - {role: zabbix-agent, tags: [zabbix-agent]}

# Data Node Deployment
#
- name: Deploy MySQL servers
  hosts: mysql_servers
  become: yes
  vars_files:
    - ["secrets/deployment-vars", "deployment-vars.example"]
    - ["secrets/host_vars/{{inventory_hostname}}", "vars/empty"]
  roles:
    - {role: mysql, tags: [mysql]}

- name: Deploy Rabbitmq servers
  hosts: rabbit_servers
  become: yes
  vars_files:
    - ["secrets/deployment-vars", "deployment-vars.example"]
    - ["secrets/host_vars/{{inventory_hostname}}", "vars/empty"]
  roles:
    - {role: rabbitmq, tags: [rabbitmq]}

# Adding Ceph Monitors
#
- name: Deploy Ceph monitors
  hosts: ceph_monitors
  become: yes
  vars_files:
    - ["secrets/deployment-vars", "deployment-vars.example"]
    - ["secrets/host_vars/{{inventory_hostname}}", "vars/empty"]
  roles:
    - {role: ceph, osd: False, mon: True}

- name: Configure Ceph cluster
  hosts: hostvars[groups['ceph_monitors'][0]]['ansible_fqdn']
  become: yes
  vars_files:
    - ["secrets/deployment-vars", "deployment-vars.example"]
    - ["secrets/host_vars/{{inventory_hostname}}", "vars/empty"]
  roles:
    - {role: ceph-bootstrap}

# Controller Deployment
#
- name: Configure OpenStack client app
  hosts: cli_servers
  become: yes
  vars_files:
    - ["secrets/deployment-vars", "deployment-vars.example"]
    - ["secrets/host_vars/{{inventory_hostname}}", "vars/empty"]
  roles:
    - {role: cli, tags: [cli]}

- name: Configure Keystone
  hosts: keystone_servers
  become: yes
  vars_files:
    - ["secrets/deployment-vars", "deployment-vars.example"]
    - ["secrets/host_vars/{{inventory_hostname}}", "vars/empty"]
  roles:
    - {role: keystone, tags: [keystone]}

- name: Configure memcache
  hosts: memcache_servers
  become: yes
  vars_files:
    - ["secrets/deployment-vars", "deployment-vars.example"]
    - ["secrets/host_vars/{{inventory_hostname}}", "vars/empty"]
  roles:
    - {role: memcached, tags: [memcached]}

- name: Configure Glance
  hosts: glance_servers
  become: yes
  vars_files:
    - ["secrets/deployment-vars", "deployment-vars.example"]
    - ["secrets/host_vars/{{inventory_hostname}}", "vars/empty"]
  roles:
    - {role: glance, tags: [glance]}

- name: Configure Nova API
  hosts: nova_servers
  become: yes
  vars_files:
    - ["secrets/deployment-vars", "deployment-vars.example"]
    - ["secrets/host_vars/{{inventory_hostname}}", "vars/empty"]
  roles:
    - {role: nova, tags: [nova]}

- name: Configure Neutron API
  hosts: neutron_servers
  become: yes
  vars_files:
    - ["secrets/deployment-vars", "deployment-vars.example"]
    - ["secrets/host_vars/{{inventory_hostname}}", "vars/empty"]
  roles:
    - {role: neutron, tags: [neutron]}

- name: Configure Cinder API
  hosts: cinder_servers
  become: yes
  vars_files:
    - ["secrets/deployment-vars", "deployment-vars.example"]
    - ["secrets/host_vars/{{inventory_hostname}}", "vars/empty"]
  roles:
    - {role: cinder, tags: [cinder]}

- name: Configure  Horizon
  hosts: horizon_servers
  become: yes
  vars_files:
    - ["secrets/deployment-vars", "deployment-vars.example"]
    - ["secrets/host_vars/{{inventory_hostname}}", "vars/empty"]
  roles:
    - {role: horizon, tags: [horizon]}

- name: Configure Heat API
  hosts: heat_servers
  become: yes
  vars_files:
    - ["secrets/deployment-vars", "deployment-vars.example"]
    - ["secrets/host_vars/{{inventory_hostname}}", "vars/empty"]
  roles:
    - {role: heat, tags: [heat]}

# Networking node Deployment
#
- name: Configure Nics and Neutron
  hosts: networking_servers
  become: yes
  vars_files:
    - ["secrets/deployment-vars", "deployment-vars.example"]
    - ["secrets/host_vars/{{inventory_hostname}}", "vars/empty"]
  roles:
    - {role: nics, tags: [nics]}
    - {role: network, tags: [network]}

# Compute Nodes Deployment
#
- name: Configure Ceph OSDs
  hosts: ceph_osds
  become: yes
  vars_files:
    - ["secrets/deployment-vars", "deployment-vars.example"]
    - ["secrets/host_vars/{{inventory_hostname}}", "vars/empty"]
  roles:
    - {role: ceph, osd: True, mon: False}

- name: Configure Compute
  hosts: compute_servers
  become: yes
  vars_files:
    - ["secrets/deployment-vars", "deployment-vars.example"]
    - ["secrets/host_vars/{{inventory_hostname}}", "vars/empty"]
  roles:
    - {role: compute, tags: [compute]}
    - {role: nics, tags: [nics]}
    - {role: ceph, osd: False, mon: False}

- name: Configure Cinder Volumes
  hosts: compute_servers
  become: yes
  vars_files:
    - ["secrets/deployment-vars", "deployment-vars.example"]
    - ["secrets/host_vars/{{inventory_hostname}}", "vars/empty"]
  roles:
    - {role: cinder-volume, tags: [cinder-volume]}


# Deploy Zabbix
- name: Configure zabbix-server
  hosts: zabbix_server
  vars_files:
    - ["secrets/deployment-vars", "deployment-vars.example"]
    - ["secrets/host_vars/{{inventory_hostname}}", "vars/empty"]
  become: yes
  roles:
    - {role: zabbix-server, tags: [zabbix-server]}

