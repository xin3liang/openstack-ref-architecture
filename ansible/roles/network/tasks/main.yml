- include: roles/common/deploy_pkg.yml pkg_name={{neutron_compute_pkg}}

- name: Ensure ovs is enabled and running
  service: name={{ovs_daemon}} enabled=true state=started

- name: Check if external bridge exists
  command: ovs-vsctl br-exists br-ex
  register: bridge_exists
  ignore_errors: yes
  changed_when: False

- name: Create external bridge
  when: bridge_exists is defined and bridge_exists.rc == 2
  command: ovs-vsctl add-br br-ex

- name: Check if external bridge is configured
  command: ovs-vsctl list-ports br-ex
  register: bridge_ports
  changed_when: False

- name: Add external interface to the bridge
  when: "bridge_ports is defined and '{{network_external_iface}}' not in bridge_ports.stdout"
  command: ovs-vsctl add-port br-ex {{network_external_iface}}

- name: Configure neutron.conf
  template: src=roles/neutron/templates/neutron.conf dest=/etc/neutron/neutron.conf
  notify: restart-network-service

- name: Configure openvswitch_agent.ini
  template: src=openvswitch_agent.ini dest=/etc/neutron/plugins/ml2/
  notify: restart-network-service

- name: Configure l3_agent.ini
  template: src=l3_agent.ini dest=/etc/neutron/
  notify: restart-network-service

- name: Configure dhcp_agent.ini
  template: src=dhcp_agent.ini dest=/etc/neutron/
  notify: restart-network-service

- name: Configure metadata_agent.ini
  template: src=metadata_agent.ini dest=/etc/neutron/
  notify: restart-network-service

- name: Ensure the network daemons are enabled
  service: name={{item}} enabled=yes state=started
  with_items:
    - erp-neutron-dhcp-agent
    - erp-neutron-l3-agent
    - erp-neutron-metadata-agent
    - erp-neutron-openvswitch-agent
